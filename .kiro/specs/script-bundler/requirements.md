# Requirements Document

## Introduction

Script-bundler is a web service that converts user-generated installation scripts from packmate into native executables. The service accepts shell scripts (PowerShell for Windows, Bash for macOS/Linux) and bundles them into platform-native executable formats (.exe for Windows, .app for macOS) that users can download and run without requiring command-line knowledge.

The service will be deployed on render.com as a Docker-based service and integrate with packmate's existing script generation system.

## Glossary

- **Script_Bundler**: The web service that converts scripts to executables
- **Bundling_Engine**: The component that wraps scripts into native executables using platform-specific tools
- **Script_Validator**: The component that validates and sanitizes input scripts before bundling
- **Executable_Store**: Temporary storage for generated executables pending download
- **Packmate_Script**: A shell script generated by packmate containing package installation commands
- **Target_Platform**: The operating system for which the executable is generated (Windows, macOS, Linux)

## Requirements

### Requirement 1: Script Submission API

**User Story:** As a packmate user, I want to submit my installation script to the bundler service, so that I can receive a native executable for my target platform.

#### Acceptance Criteria

1. WHEN a client submits a POST request with script content and target platform, THE Script_Bundler SHALL accept the request and return a job identifier
2. WHEN the script content is empty or missing, THE Script_Bundler SHALL return a 400 error with a descriptive message
3. WHEN the target platform is not supported, THE Script_Bundler SHALL return a 400 error listing supported platforms
4. THE Script_Bundler SHALL accept PowerShell scripts for Windows targets
5. THE Script_Bundler SHALL accept Bash scripts for macOS and Linux targets
6. WHEN a request exceeds the maximum script size limit, THE Script_Bundler SHALL return a 413 error

### Requirement 2: Script Validation and Sanitization

**User Story:** As a service operator, I want all submitted scripts to be validated and sanitized, so that malicious code cannot be executed on the bundling server.

#### Acceptance Criteria

1. WHEN a script is submitted, THE Script_Validator SHALL check for prohibited commands and patterns
2. WHEN a script contains prohibited patterns, THE Script_Validator SHALL reject the script with a specific error message
3. THE Script_Validator SHALL reject scripts containing network commands that download arbitrary executables
4. THE Script_Validator SHALL reject scripts containing file system operations outside expected paths
5. THE Script_Validator SHALL reject scripts containing encoded or obfuscated content
6. WHEN a script passes validation, THE Script_Validator SHALL return a sanitized version ready for bundling
7. THE Script_Validator SHALL verify the script matches the expected packmate output format

### Requirement 3: Windows Executable Generation

**User Story:** As a Windows user, I want to receive a .exe file containing my installation script, so that I can run it by double-clicking.

#### Acceptance Criteria

1. WHEN a validated PowerShell script is submitted for Windows, THE Bundling_Engine SHALL generate a .exe file
2. THE Bundling_Engine SHALL embed the PowerShell script within the executable
3. WHEN the executable is run, THE Bundling_Engine SHALL ensure it launches PowerShell with appropriate execution policy
4. THE Bundling_Engine SHALL generate executables that request administrator privileges when needed
5. IF executable generation fails, THEN THE Bundling_Engine SHALL return an error with diagnostic information

### Requirement 4: macOS Application Bundle Generation

**User Story:** As a macOS user, I want to receive a .app bundle containing my installation script, so that I can run it like a native application.

#### Acceptance Criteria

1. WHEN a validated Bash script is submitted for macOS, THE Bundling_Engine SHALL generate a .app bundle
2. THE Bundling_Engine SHALL embed the Bash script within the application bundle
3. WHEN the application is run, THE Bundling_Engine SHALL ensure it launches Terminal with the script
4. THE Bundling_Engine SHALL generate application bundles with appropriate Info.plist metadata
5. IF application bundle generation fails, THEN THE Bundling_Engine SHALL return an error with diagnostic information

### Requirement 5: Executable Download

**User Story:** As a user, I want to download my generated executable, so that I can use it on my computer.

#### Acceptance Criteria

1. WHEN an executable is ready, THE Script_Bundler SHALL provide a download endpoint with the job identifier
2. WHEN a download is requested, THE Script_Bundler SHALL return the executable with appropriate Content-Type and Content-Disposition headers
3. WHEN a download is requested for a non-existent job, THE Script_Bundler SHALL return a 404 error
4. WHEN a download is requested for an expired job, THE Script_Bundler SHALL return a 410 error indicating the file has expired
5. THE Script_Bundler SHALL support downloading executables as a ZIP archive for macOS .app bundles

### Requirement 6: Job Status Tracking

**User Story:** As a user, I want to check the status of my bundling job, so that I know when my executable is ready.

#### Acceptance Criteria

1. WHEN a job is submitted, THE Script_Bundler SHALL return a job identifier that can be used to check status
2. WHEN a status check is requested, THE Script_Bundler SHALL return the current job state (queued, processing, completed, failed)
3. WHEN a job is completed, THE Script_Bundler SHALL include the download URL in the status response
4. WHEN a job has failed, THE Script_Bundler SHALL include an error message in the status response
5. WHEN a status check is requested for a non-existent job, THE Script_Bundler SHALL return a 404 error

### Requirement 7: Temporary File Cleanup

**User Story:** As a service operator, I want temporary files to be automatically cleaned up, so that disk space is managed efficiently.

#### Acceptance Criteria

1. THE Executable_Store SHALL delete generated executables after a configurable timeout period
2. THE Executable_Store SHALL delete generated executables immediately after successful download
3. THE Executable_Store SHALL delete temporary build artifacts after job completion or failure
4. WHEN cleanup occurs, THE Executable_Store SHALL log the cleanup action for monitoring purposes

### Requirement 8: Rate Limiting and Security

**User Story:** As a service operator, I want to protect the service from abuse, so that it remains available for legitimate users.

#### Acceptance Criteria

1. THE Script_Bundler SHALL enforce rate limits per IP address
2. WHEN rate limits are exceeded, THE Script_Bundler SHALL return a 429 error with retry-after information
3. THE Script_Bundler SHALL validate Content-Type headers on incoming requests
4. THE Script_Bundler SHALL set appropriate security headers on all responses
5. THE Script_Bundler SHALL log all requests for security auditing

### Requirement 9: Packmate Integration

**User Story:** As a packmate developer, I want the bundler service to integrate seamlessly with packmate, so that users can generate executables directly from the packmate interface.

#### Acceptance Criteria

1. THE Script_Bundler SHALL accept scripts in the exact format generated by packmate's script generators
2. THE Script_Bundler SHALL provide CORS headers allowing requests from packmate's domain
3. THE Script_Bundler SHALL expose a health check endpoint for monitoring integration status
4. WHEN packmate sends a script with metadata, THE Script_Bundler SHALL use the metadata to customize the executable name

### Requirement 10: Deployment Configuration

**User Story:** As a DevOps engineer, I want the service to be deployable on render.com, so that it can be hosted reliably.

#### Acceptance Criteria

1. THE Script_Bundler SHALL be containerized using Docker with all bundling tools pre-installed
2. THE Script_Bundler SHALL read configuration from environment variables
3. THE Script_Bundler SHALL expose a health check endpoint at /health
4. THE Script_Bundler SHALL log to stdout in a structured format for render.com log aggregation
5. THE Script_Bundler SHALL handle graceful shutdown on SIGTERM signal
